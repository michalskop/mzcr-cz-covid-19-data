
name: Scrape latest data

on:
  push:
  workflow_dispatch:
  schedule:
    - cron:  '11 1,9,17 * * *'

jobs:
  scheduled:
    runs-on: ubuntu-latest
    steps:
    - name: Check out this repo
      uses: actions/checkout@v2
    # - name: Fetch latest data mestske-casti.csv
    #  run: |-
    #    curl "https://share.uzis.cz/s/dCZBiARJ27ayeoS/download?path=%2F&files=mestske-casti.csv" > mestske-casti.csv
    - name: Fetch latest data https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/mestske-casti.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/mestske-casti.csv" > mestske-casti.csv
    - name: Fetch latest data obec.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/obce.csv" > obec.csv
        HEADER=`head -n 1 obec.csv`
        echo $HEADER > header.csv
        N1=`grep -nr "5/19/2020 12:00:00 AM" obec.csv | gawk '{print $1}' FS=":" | tail -n 1`
        N2=`grep -nr "8/7/2020 12:00:00 AM" obec.csv | gawk '{print $1}' FS=":" | tail -n 1`
        N3=`grep -nr "10/26/2020 12:00:00 AM" obec.csv | gawk '{print $1}' FS=":" | tail -n 1`
        N4=`grep -nr "1/14/2021 12:00:00 AM" obec.csv | gawk '{print $1}' FS=":" | tail -n 1`
        N5=`grep -nr "3/4/2021 12:00:00 AM" obec.csv | gawk '{print $1}' FS=":" | tail -n 1`
        TOTAL=`wc -l obec.csv | cut -f1 -d' '`
        head -$N1 obec.csv > obec_1_v2.csv
        head -n $N2 obec.csv | tail -n `expr $N2 - $N1` > obec_2_tmp.csv
        head -n $N3 obec.csv | tail -n `expr $N3 - $N2` > obec_3_tmp.csv
        head -n $N4 obec.csv | tail -n `expr $N4 - $N3` > obec_4_tmp.csv
        head -n $N5 obec.csv | tail -n `expr $N5 - $N4` > obec_5_tmp.csv
        cat header.csv obec_2_tmp.csv > obec_2_v2.csv
        cat header.csv obec_3_tmp.csv > obec_3_v2.csv
        cat header.csv obec_4_tmp.csv > obec_4_v2.csv
        cat header.csv obec_5_tmp.csv > obec_5_v2.csv
        tail -n `expr $TOTAL - $N5` obec.csv > obec_6_tmp.csv
        cat header.csv obec_6_tmp.csv > obec_6_v2.csv
        rm obec.csv obec_2_tmp.csv obec_3_tmp.csv obec_4_tmp.csv obec_5_tmp.csv obec_6_tmp.csv header.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/testy.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/testy.csv" > testy.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/nakaza.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/nakaza.csv" > nakaza.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/nakazeni-vyleceni-umrti-testy.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/nakazeni-vyleceni-umrti-testy.csv" > nakazeni-vyleceni-umrti-testy.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/zakladni-prehled.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/zakladni-prehled.csv" > zakladni-prehled.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/osoby.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/osoby.csv" > osoby.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/kraj-okres-nakazeni-vyleceni-umrti.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/kraj-okres-nakazeni-vyleceni-umrti.csv" > kraj-okres-nakazeni-vyleceni-umrti.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/vyleceni.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/vyleceni.csv" > vyleceni.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/umrti.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/umrti.csv" > umrti.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/pomucky.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/pomucky.csv" > pomucky.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/orp.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/orp.csv" > orp.csv
    # - name: Fetch latest https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_CR.csv
    #  run: |-
    #    curl "https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_CR.csv" > pes_CR.csv
    # - name: Fetch latest https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_kraje.csv
    #  run: |-
    #    curl "https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_kraje.csv" > pes_kraje.csv
    # - name: Fetch latest https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_okresy.csv
    #  run: |-
    #    curl "https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_okresy.csv" > pes_okresy.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/testy-pcr-antigenni.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/testy-pcr-antigenni.csv" > testy-pcr-antigenni.csv
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/hospitalizace.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/hospitalizace.csv" > hospitalizace.csv
    - name: Fetch latest data https://share.uzis.cz/s/ZEAZtS4dWQXKWF4/download
      run: |-
        curl "https://share.uzis.cz/s/ZEAZtS4dWQXKWF4/download" > covid-19-vakcinace-cr.csv
    - name: Fetch latest data https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovani.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovani.csv" > ockovani.csv
    - name: Fetch latest data https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovaci-mista.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovaci-mista.csv" > ockovaci-mista.csv
    - name: Fetch latest data https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/kraj-okres-testy.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/kraj-okres-testy.csv"
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/prehled-ockovacich-mist.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/prehled-ockovacich-mist.csv"
    - name: Fetch latest https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/prehled-odberovych-mist.csv
      run: |-
        curl "https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/prehled-odberovych-mist.csv"
    - name: Fetch data https://dip.mzcr.cz/api/v1/kapacity-intenzivni-pece-vlna-2.csv
      run: |-
        curl "https://dip.mzcr.cz/api/v1/kapacity-intenzivni-pece-vlna-2.csv"
    - name: Fetch data https://dip.mzcr.cz/api/v1/kapacity-intenzivni-pece-zdravotnicke-zarizeni.csv
      run: |-
        curl "https://dip.mzcr.cz/api/v1/kapacity-intenzivni-pece-zdravotnicke-zarizeni.csv"
    - name: Fetch latest https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_CR_verze2.csv
      run: |-
        curl "https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_CR_verze2.csv" > pes_CR_verze2.csv
    - name: Fetch latest https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_kraje_verze2.csv
      run: |-
        curl "https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_kraje_verze2.csv" > pes_kraje_verze2.csv
    - name: Fetch latest https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_okresy_verze2.csv
      run: |-
        curl "https://share.uzis.cz/s/BRfppYFpNTddAy4/download?path=%2F&files=pes_okresy_verze2.csv" > pes_okresy_verze2.csv

        
    - name: Commit and push if it changed
      run: |-
        git config user.name "Automated"
        git config user.email "actions@users.noreply.github.com"
        git add -A
        timestamp=$(date -u)
        git commit -m "Latest data: ${timestamp}" || exit 0
        git push
